trigger:
  branches:
    include:
    - main
    - develop

parameters:
- name: deployScaleset
  type: boolean
  displayName: Deploy scaleset (image has been tested manually)
  default: false

variables:
- group: TF_PIPELINES
- name: poolName
  value: 'Azure Pipelines'
- name: vmImage
  value: 'ubuntu-latest'
- name: projectRoot
  value: $(System.DefaultWorkingDirectory)
# image related vars
- name: gallery_rg_name
  value: 'dani-resource-group'
- name: gallery_name
  value: 'winGallery'
- name: image_name
  value: 'test-image-1'
- name: image_publisher
  value: 'DanielaBG'
- name: image_offer
  value: 'WindowsServer'
- name: image_sku
  value: 'Example1234'
- name: image_version
  value: "1.0.1"
# packer related vars
- name: packer_rg_name
  value: 'project1-packer-rg'
- name: projectDirectory
  value: 'Project1'
- name: packerJsonFileName
  value: 'windows-template-project1.json'
- name: azure_location
  value: 'eastus'
# Scale set related vars
- name: scaleset_rg
  value: 'project1-scaleset-rg'
- name: scaleset_vnet
  value: 'project1-scaleset-vnet'
- name: scaleset_subnet_name
  value: 'project1-scaleset-subnet'
- name: scaleset_name
  value: 'project1-vmscaleset-for-azdo'
- name: vm_size
  value: 'Standard_D2_v2'
- name: os_disk_size
  value: '256'
- name: scaleset_extra_secret_var
  value: 'vm_admin_password=$(VM_password)'
# Terraform working directories
- name: imgDefTerraformDirectory
  value: '$(Build.Repository.LocalPath)/$(projectDirectory)/image_def'
- name: packerRgTerraformDirectory
  value: '$(Build.Repository.LocalPath)/$(projectDirectory)/packer_rg'
- name: scaleSetTerraformDirectory
  value: '$(Build.Repository.LocalPath)/$(projectDirectory)/vm_scaleset'

stages:
- stage: TerraformPrereq
  displayName: Deploy Terraform requirements for packer
  pool:
    name: $(poolName)
    vmImage: $(vmImage)

  jobs:
  - job: terraformImgDef
    displayName: Terraform image definition
    workspace:
      clean: all
    steps:
      - checkout: self
      - task: CopyFiles@2
        displayName: 'copy script to terraform directory'
        inputs:
          SourceFolder: '$(Build.Repository.LocalPath)/scripts'
          Contents: |
            write_img_def_tfvars.sh
          TargetFolder: $(imgDefTerraformDirectory)
          OverWrite: true
      - script: |
          chmod +x write_img_def_tfvars.sh
          ./write_img_def_tfvars.sh
          ##[debug] cat terraform.tfvars
          cat terraform.tfvars
        workingDirectory: $(imgDefTerraformDirectory)
        displayName: 'Create tfvars file from global variables'
        env:
          gallery_rg_name: $(gallery_rg_name)
          gallery_name: $(gallery_name)
          image_name: $(image_name)
          image_publisher: $(image_publisher)
          image_offer: $(image_offer)
          image_sku: $(image_sku)

      - template: '../templates/terraform_plan_template.yml'
        parameters:
          tfWorkingDir: $(imgDefTerraformDirectory)
      - template: '../templates/terraform_apply_template.yml'
        parameters:
          tfWorkingDir: $(imgDefTerraformDirectory)

  - job: terraformRG
    dependsOn: terraformImgDef
    displayName: Terraform packer resource group
    workspace:
      clean: all
    steps:
      - checkout: self
      - script: |
          ##[debug] Creating terraform.tfvars for packer rg
          cat <<EOF > "terraform.tfvars"
          packer_rg_name     = "$packer_rg_name"
          packer_rg_location = "$packer_rg_location"
          EOF
          ##[debug] cat terraform.tfvars
          cat terraform.tfvars
        workingDirectory: $(packerRgTerraformDirectory)
        displayName: 'Create tfvars file from global variables'
        env:
          packer_rg_name: $(packer_rg_name)
          packer_rg_location: $(azure_location)
      - template: '../templates/terraform_plan_template.yml'
        parameters:
          tfWorkingDir: $(packerRgTerraformDirectory)
      - template: '../templates/terraform_apply_template.yml'
        parameters:
          tfWorkingDir: $(packerRgTerraformDirectory)

- stage: packerBuild
  dependsOn: TerraformPrereq
  displayName: Build Packer Image
  pool:
    name: $(poolName)
    vmImage: $(vmImage)

  jobs:
  - job: packer
    timeoutInMinutes: 130
    displayName: packer build image
    workspace:
      clean: all
    steps:
      - checkout: self

      - template: ../templates/packer_pipeline_template.yml
        parameters:
          imageName: $(image_name)
          galleryName: $(gallery_name)
          galleryResourceGroup: $(gallery_rg_name)
          packerResourceGroup: $(packer_rg_name)
          imageVersion: $(image_version)
          templateDirectory: $(projectDirectory)
          packerJsonFileName: $(packerJsonFileName)
          vm_size: $(vm_size)
          galleryRegion: $(azure_location)


- stage: TerraformScaleset
  dependsOn: packerBuild
  condition: and(succeededOrFailed(), eq('${{ parameters.deployScaleset }}' , 'true'))
  displayName: Deploy Terraform scaleset with packer image
  pool:
    name: $(poolName)
    vmImage: $(vmImage)

  jobs:
  - job: terraformScaleset
    displayName: Terraform scale set
    workspace:
      clean: all
    steps:
      - checkout: self
      - task: CopyFiles@2
        displayName: 'copy script to terraform directory'
        inputs:
          SourceFolder: '$(Build.Repository.LocalPath)/scripts'
          Contents: |
            write_scaleset_tfvars.sh
          TargetFolder: $(scaleSetTerraformDirectory)
          OverWrite: true
      - script: |
          chmod +x write_scaleset_tfvars.sh
          ./write_scaleset_tfvars.sh
          ##[debug] cat terraform.tfvars
          cat terraform.tfvars
        workingDirectory: $(scaleSetTerraformDirectory)
        displayName: 'Create tfvars file from global variables'
        env:
          scaleset_rg: $(scaleset_rg)
          location: $(azure_location)
          scaleset_vnet: $(scaleset_vnet)
          scaleset_subnet_name: $(scaleset_subnet_name)
          scaleset_name: $(scaleset_name)
          vm_size: $(vm_size)
          os_disk_size: $(os_disk_size)
          image_version: $(image_version)
          gallery_rg_name: $(gallery_rg_name)
          gallery_name: $(gallery_name)
          image_name: $(image_name)


      - template: '../templates/terraform_plan_template.yml'
        parameters:
          tfWorkingDir: $(scaleSetTerraformDirectory)
          extraArgs: $(scaleset_extra_secret_var)
      - template: '../templates/terraform_apply_template.yml'
        parameters:
          tfWorkingDir: $(scaleSetTerraformDirectory)
          extraArgs: $(scaleset_extra_secret_var)
