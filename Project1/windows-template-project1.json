{
    "variables": {
        "az_client_secret": "{{env `ARM_CLIENT_SECRET`}}",
        "az_subscription_id": "{{env `ARM_SUBSCRIPTION_ID`}}",
        "az_client_id": "{{env `ARM_CLIENT_ID`}}",
        "az_tenant_id": "{{env `ARM_TENANT_ID`}}",
        "resourcegroup": "{{env `PACKER_RG`}}",
        "gallery_resource_group": "{{env `GALLERY_RG`}}",
        "gallery_name": "{{env `GALLERY_NAME`}}",
        "image_version": "{{env `IMAGE_VERSION`}}",
        "image_name": "{{env `IMAGE_NAME`}}"
    },
    "builders": [
        {
            "type": "azure-arm",

            "client_id": "{{user `az_client_id`}}",
            "client_secret": "{{user `az_client_secret`}}",
            "tenant_id": "{{user `az_tenant_id`}}",
            "subscription_id": "{{user `az_subscription_id`}}",

            "os_type": "Windows",
            "image_publisher": "MicrosoftWindowsServer",
            "image_offer": "WindowsServer",
            "image_sku": "2019-Datacenter",

            "communicator": "winrm",
            "winrm_use_ssl": true,
            "winrm_insecure": true,
            "winrm_timeout": "5m",
            "winrm_username": "packer",

            "azure_tags": {
                "ENV": "test",
                "image": "test-windows"
            },

            "vm_size": "Standard_D2_v2",

            "build_resource_group_name": "{{user `resourcegroup`}}",
            "custom_resource_build_prefix": "temporal",

            "shared_image_gallery_destination": {
                "resource_group": "{{user `gallery_resource_group`}}",
                "gallery_name": "{{user `gallery_name`}}",
                "image_name":  "{{user `image_name`}}",
                "image_version": "{{user `image_version`}}",
                "replication_regions": ["uksouth"],
                "storage_account_type": "Standard_LRS"
            },

            "managed_image_name":  "{{user `image_name`}}",
            "managed_image_resource_group_name": "{{user `resourcegroup`}}"

        }
    ],
    "provisioners": [
        {   "type": "powershell",
            "inline": ["Set-ExecutionPolicy Bypass -Scope Process -Force"]
        },
        {
            "type": "powershell",
            "script": "scripts/ConfigureRemotingForAnsible.ps1"
        },
        {
            "type": "ansible",
            "playbook_file": "Project1/playbook_project1.yml",
            "use_proxy": false,
            "user": "packer",
            "extra_arguments": ["-vvvv",
                "-e", "ansible_winrm_server_cert_validation=ignore"]
      },
      {
        "type": "powershell",
        "inline": [
            "Set-Service RdAgent -StartupType Disabled",
            "Set-Service WindowsAzureGuestAgent -StartupType Disabled",
            "Remove-ItemProperty -Path 'HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\SysPrepExternal\\Generalize' -Name '*'"
          ]
      },
      {
        "type": "windows-restart",
        "restart_check_command": "powershell -command \"& {Write-Output 'restarted.'}\""
      },
      {
        "type": "powershell",
        "inline": [
          "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
          "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
        ]
      }
    ]
}
